import{q as J,r as b,a as n,j as r,f as C}from"./app-c8a88dda.js";function K({title:A,routeName:M,restaurant:y,products:h,currentMonth:S}){const{auth:c,processing:T}=J().props;console.log("Auth user:",c.user),console.log("Guest status raw:",c.user.guest);const l=c.user.guest===1||c.user.guest===!0||c.user.guest==="1"||String(c.user.guest).toLowerCase()==="true";console.log("Final guest detection:",l);const z=typeof c.user.role=="string"?JSON.parse(c.user.role):Array.isArray(c.user.role)?c.user.role:[],g=!l&&H(z),x=!l&&Y(z);function H(e){const t=["Cost-Cuisine","Cost-Pizza","Cost-Economat","Cost-Consomable"];return e.some(s=>t.includes(s))}function Y(e){const t=["Audit","Admin","Analytics"];return e.some(s=>t.includes(s))}const[d,B]=b.useState(new Date(S.year,S.month-1)),[m,P]=b.useState(null),[q,w]=b.useState(!1),v=Array.from({length:new Date(d.getFullYear(),d.getMonth()+1,0).getDate()},(e,t)=>t+1);b.useEffect(()=>{console.log("Component mounted, guest status:",l)},[]);const L=e=>{const t=new Date(e.target.value);B(t),C.get(window.location.pathname,{month:t.getMonth()+1,year:t.getFullYear()},{preserveState:!0,preserveScroll:!0,only:["products","currentMonth"]})},p=(e,t)=>{const s=parseFloat(o(e,t,"morning"))||0,i=parseFloat(o(e,t,"afternoon"))||0;return(s+i)*(e.prix||0)},N=e=>h.reduce((t,s)=>t+p(s,e),0),O=()=>v.reduce((e,t)=>e+N(t),0),W=e=>v.reduce((t,s)=>{const i=parseFloat(o(e,s,"morning"))||0,a=parseFloat(o(e,s,"afternoon"))||0;return t+i+a},0),V=(e,t,s,i)=>{if(l){console.log("Blocked edit attempt by guest user");return}if(!j(e,t)){alert("You don't have permission to edit this entry.");return}const a=s==="morning"?parseFloat(i)||0:parseFloat(o(e,t,"morning"))||0,u=s==="afternoon"?parseFloat(i)||0:parseFloat(o(e,t,"afternoon"))||0,$=(a+u)*(e.prix||0);let f={...e.values||{}};f[t]||(f[t]={morning:0,afternoon:0,total:0,status:"pending"}),f[t]={morning:a,afternoon:u,total:$,status:f[t].status||"pending"};let F=0;h.forEach(_=>{_.id===e.id?F+=$:F+=p(_,t)}),C.post(route(M),{restaurant_id:y.id,product_id:e.id,day:t,month:d.getMonth()+1,year:d.getFullYear(),period:s,value:i||0,daily_data:f[t],day_total:F},{preserveScroll:!0,preserveState:!0})},G=e=>{if(l){console.log("Blocked verification attempt by guest user");return}P(e),w(!0)},I=()=>{if(l){console.log("Blocked verification confirmation by guest user");return}m&&(h.forEach(e=>{k(e,m)&&C.post(route(M),{restaurant_id:y.id,product_id:e.id,day:m,month:d.getMonth()+1,year:d.getFullYear(),period:"morning",value:o(e,m,"morning"),daily_data:{morning:parseFloat(o(e,m,"morning"))||0,afternoon:parseFloat(o(e,m,"afternoon"))||0,total:p(e,m),status:"verified"},day_total:N(m),verify:!0},{preserveScroll:!0,preserveState:!0})}),w(!1))},k=(e,t)=>e.values&&e.values[t]&&(parseFloat(e.values[t].morning)>0||parseFloat(e.values[t].afternoon)>0),j=(e,t)=>{if(l)return!1;if(x)return!0;if(g){if(!e.values||!e.values[t])return!0;const s=e.values[t].status||"pending",i=e.values[t].created_at;if(s==="pending"&&i){const a=new Date().toDateString(),u=new Date(i).toDateString();return a===u}return!1}return!1},E=(e,t)=>e.values&&e.values[t]&&e.values[t].status==="verified",D=e=>h.every(t=>!k(t,e)||E(t,e)),R=e=>{e.target.blur()},o=(e,t,s)=>!e.values||!e.values[t]?"":e.values[t][s]||"";return n("div",{className:"flex flex-col h-full",children:[T&&r("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:r("div",{className:"bg-white p-4 rounded-lg",children:"Loading..."})}),!l&&(g||x)&&r("div",{className:`${g?"bg-blue-50 border-blue-200":"bg-green-50 border-green-200"} border-b p-3`,children:n("div",{className:"flex items-center justify-center",children:[r("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-5 w-5 ${g?"text-blue-600":"text-green-600"} mr-2`,viewBox:"0 0 20 20",fill:"currentColor",children:r("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),r("span",{className:`font-medium ${g?"text-blue-800":"text-green-800"}`,children:g?"Mode saisie. Vous pouvez ajouter de nouvelles données ou modifier vos saisies du jour.":"Mode vérification. Vous pouvez vérifier et modifier toutes les entrées."})]})}),l&&r("div",{className:"bg-yellow-50 border-b border-yellow-200 p-3",children:n("div",{className:"flex items-center justify-center",children:[r("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-yellow-600 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:r("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),r("span",{className:"font-medium text-yellow-800",children:"Mode consultation uniquement. Vous ne pouvez pas modifier les données."})]})}),n("div",{className:"bg-white p-4 border-b shadow-sm",children:[n("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4 max-w-7xl mx-auto",children:[n("div",{children:[r("h1",{className:"text-xl font-semibold text-gray-900",children:A}),n("p",{className:"text-sm text-gray-600",children:[y.name," - ",d.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})]})]}),r("input",{type:"month",value:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`,onChange:L,className:"border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500'}"})]}),r("div",{className:"mt-4 flex justify-center",children:n("div",{className:"bg-green-50 border border-green-200 rounded-lg px-6 py-3 shadow-sm",children:[r("h2",{className:"text-sm font-medium text-green-700 text-center",children:"Total du Mois"}),n("p",{className:"text-2xl font-bold text-green-800 text-center",children:[O().toFixed(2),"DH"]})]})})]}),r("div",{className:"sm:hidden bg-blue-50 p-2 text-center text-xs text-blue-700",children:"Swipe horizontally to see more days →"}),r("div",{className:"flex-1 overflow-hidden",children:r("div",{className:"h-full overflow-y-auto",children:r("div",{className:"overflow-x-auto pb-4 min-w-full",children:n("table",{className:"w-full border-collapse min-w-max",children:[r("thead",{className:"bg-gray-50 sticky top-0 z-20",children:n("tr",{children:[r("th",{className:"sticky left-0 z-30 bg-gray-50 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider max-w-[130px] sm:max-w-none px-2 sm:px-6",children:"Produit"}),v.map(e=>n("th",{className:"px-3 py-3 text-center border-x min-w-[90px]",children:[n("div",{className:"flex justify-between items-center mb-1",children:[r("div",{className:"text-xs font-medium text-gray-500 uppercase tracking-wider",children:e}),x&&r("button",{onClick:()=>G(e),className:`px-2 py-0.5 rounded text-xs ${D(e)?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:D(e)?"Vérifié":"Vérifier"}),(l||!x)&&D(e)&&r("span",{className:"px-2 py-0.5 rounded text-xs bg-green-100 text-green-800",children:"Vérifié"})]}),n("div",{className:"text-sm font-semibold text-green-600",children:[N(e).toFixed(2),"DH"]}),n("div",{className:"grid grid-cols-2 gap-2 mt-1",children:[r("div",{className:"text-xs text-gray-500",children:"Matin"}),r("div",{className:"text-xs text-gray-500",children:"Midi"})]})]},e))]})}),r("tbody",{className:"bg-white divide-y divide-gray-200",children:h.map(e=>n("tr",{className:"hover:bg-gray-50",children:[r("td",{className:"sticky left-0 bg-white border-r whitespace-nowrap z-20 hover:bg-gray-50 max-w-[140px] sm:max-w-none px-2 sm:px-6 py-2 sm:py-4",children:n("div",{className:"flex items-center gap-1 sm:gap-3",children:[r("img",{src:`https://admin.cucinanapoli.com/storage/${e.image}`,alt:e.designation,className:"h-8 w-8 sm:h-12 sm:w-12 object-cover rounded-md flex-shrink-0"}),n("div",{className:"flex flex-col min-w-0",children:[r("span",{className:"text-sm font-medium text-gray-900 truncate",children:e.designation}),n("span",{className:"text-xs text-gray-500 truncate",children:[e.prix,"DH/",e.unite]}),n("div",{className:"mt-1 text-green-700 text-xs px-2 py-1 rounded-md inline-flex items-center",children:[r("span",{className:"font-semibold",children:"Total: "}),r("span",{className:"ml-1",children:W(e).toFixed(2)})]})]})]})}),v.map(t=>{const s=E(e,t),a=!j(e,t)||l;return r("td",{className:`px-1 py-2 border-x min-w-[90px] ${s?"bg-green-50":""}`,children:n("div",{className:"flex flex-col gap-1",children:[n("div",{className:"grid grid-cols-2 gap-1",children:[r("input",{type:"number",className:`w-full border-${s?"green":"gray"}-300 rounded-sm ${a?"bg-gray-100 cursor-not-allowed":"focus:ring-green-500 focus:border-green-500"} text-sm p-1`,value:o(e,t,"morning"),onChange:u=>V(e,t,"morning",u.target.value),onWheel:R,step:"0.01",min:"0",placeholder:"0",disabled:a,readOnly:a}),r("input",{type:"number",className:`w-full border-${s?"green":"gray"}-300 rounded-sm ${a?"bg-gray-100 cursor-not-allowed":"focus:ring-green-500 focus:border-green-500"} text-sm p-1`,value:o(e,t,"afternoon"),onChange:u=>V(e,t,"afternoon",u.target.value),onWheel:R,step:"0.01",min:"0",placeholder:"0",disabled:a,readOnly:a})]}),n("div",{className:"text-xs text-right text-gray-600 pr-1",children:[p(e,t).toFixed(2),"DH"]})]})},t)})]},e.id))})]})})})}),q&&r("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:n("div",{className:"bg-white p-6 rounded-lg shadow-xl max-w-md w-full",children:[r("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Confirmer la vérification"}),n("p",{className:"text-gray-600 mb-6",children:["Êtes-vous sûr de vouloir vérifier les entrées pour le jour ",m," ? Cette action marquera toutes les entrées comme vérifiées."]}),n("div",{className:"flex justify-end gap-3",children:[r("button",{className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md",onClick:()=>w(!1),children:"Annuler"}),r("button",{className:"px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded-md",onClick:I,children:"Confirmer"})]})]})})]})}export{K as default};
