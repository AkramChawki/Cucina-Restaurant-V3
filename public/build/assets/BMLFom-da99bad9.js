import{j as e,R as ee,r as b,a as o,f as R}from"./app-6f42bc48.js";import{c as S}from"./createLucideIcon-93940a00.js";/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],re=S("CircleAlert",te);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],se=S("CircleCheckBig",ae);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],oe=S("CirclePlus",ne);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]],le=S("Trash2",ie);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],de=S("X",ce),ue=({message:i,type:l="success",onClose:n})=>(b.useEffect(()=>{const x=setTimeout(()=>{n()},3e3);return()=>clearTimeout(x)},[n]),o("div",{className:`fixed top-4 right-4 flex items-center p-4 mb-4 rounded-lg shadow-lg ${l==="success"?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:[e("div",{className:"inline-flex items-center justify-center flex-shrink-0 w-8 h-8",children:l==="success"?e(se,{className:"w-5 h-5 text-green-600"}):e(re,{className:"w-5 h-5 text-red-600"})}),e("div",{className:"ml-3 text-sm font-normal",children:i}),e("button",{onClick:n,className:"ml-4 -mx-1.5 -my-1.5 bg-transparent text-gray-400 hover:text-gray-900 rounded-lg p-1.5 inline-flex h-8 w-8",children:e(de,{className:"w-5 h-5"})})]})),me=({toasts:i,removeToast:l})=>e("div",{className:"fixed top-0 right-0 z-50 p-4 space-y-4",children:i.map(n=>e(ue,{message:n.message,type:n.type,onClose:()=>l(n.id)},n.id))}),ge=()=>{const[i,l]=ee.useState([]);return{toasts:i,addToast:(y,k="success")=>{const u=Date.now();l(A=>[...A,{id:u,message:y,type:k}])},removeToast:y=>{l(k=>k.filter(u=>u.id!==y))}}},$={gastro:["Mozzarella Milka","Creme Fraîche","PERLA CERISE","Mozzarella cerise"],giada:["Mozzarella","Stracciatella","Buratta","Ricotta"],legume:["Roquette","EPINARD","Tomate cerise","Poivron Rouge","Poivron vert","CHAMPIGNON","CITRON","ORANGUE","CONCOMBRE","AIL","Basilic","Courgette","OIGNON"],boisson:["Coca","Coca Zero","Hawaei","Sprite","POMS","Citron","Tonic"]},pe=["Kg","KG","250G","unite","L","Botte","BROT","paquet de 24 U","Pot de 1 kg"],O=i=>{if(!i)return"";try{const l=i instanceof Date?i:new Date(i),n=l.getTimezoneOffset()*6e4;return new Date(l.getTime()-n).toISOString().split("T")[0]}catch(l){return console.error("Error formatting date:",l),""}},he=i=>i.reduce((n,x)=>{const y=x.date;return y&&(n[y]||(n[y]={rows:[],total:0}),n[y].rows.push(x),n[y].total+=parseFloat(x.total_ttc)||0),n},{}),L=i=>{switch(i){case"gastro":return"GASTRO";case"giada":return"GIADA";case"legume":return"Legume";case"boisson":return"COCA COLA";default:return""}};function xe({restaurant:i,currentMonth:l,existingEntries:n=[],types:x={},currentType:y=""}){const{toasts:k,addToast:u,removeToast:A}=ge(),[m,V]=b.useState(new Date(l.year,l.month-1)),[h,H]=b.useState(y),[g,f]=b.useState(!1),z=b.useRef(!0),j=b.useRef(n),[J,B]=b.useState(null),q=()=>({id:Date.now()+Math.floor(Math.random()*1e3),fournisseur:L(h),designation:"",quantity:"",price:"",unite:"",date:O(new Date),type:h,total_ttc:0}),[D,C]=b.useState([q()]);b.useEffect(()=>{if(z.current){z.current=!1;return}const t=JSON.stringify(j.current)!==JSON.stringify(n);if(j.current=n,!!t)if(n&&n.length>0){const r=n.map((a,c)=>({id:Date.now()+c,fournisseur:a.fournisseur||L(a.type),designation:a.designation||"",quantity:a.quantity||"",price:a.price||"",unite:a.unite||"",date:O(a.date),type:a.type||h,total_ttc:parseFloat(a.total_ttc)||0}));C(r)}else C([q()])},[n]);const I=(t,r)=>{const a=parseFloat(t)||0,c=parseFloat(r)||0;return(a*c).toFixed(2)},F=t=>{if(!t)return!1;const r=new Date(t);return r.getMonth()+1!==m.getMonth()+1||r.getFullYear()!==m.getFullYear()},K=()=>{C(t=>[...t,q()])},X=t=>{C(r=>r.length<=1?r:r.filter(a=>a.id!==t))},N=(t,r,a)=>{C(c=>c.map(p=>{if(p.id===t){const v={...p,[r]:a};return r==="type"&&(v.fournisseur=L(a)),(r==="quantity"||r==="price")&&(v.total_ttc=I(r==="quantity"?a:p.quantity,r==="price"?a:p.price)),v}return p}))},Q=t=>{try{const r=t.target.value;console.log("Type changed to:",r),H(r),f(!0);const a=r===""?null:r,c=route("bml.show",[i.slug]);console.log("Navigating to:",c,"with type:",a),R.get(c,{month:m.getMonth()+1,year:m.getFullYear(),type:a},{preserveScroll:!0,preserveState:!0,onSuccess:p=>{console.log("Navigation successful",p),f(!1)},onError:p=>{console.error("Navigation error:",p),f(!1),u("Erreur lors du chargement des données.","error")}})}catch(r){console.error("Error in handleTypeChange:",r),f(!1),u("Une erreur est survenue lors du changement de type.","error")}},W=t=>{const r=new Date(t.target.value);V(r),f(!0),R.get(route("bml.show",[i.slug]),{month:r.getMonth()+1,year:r.getFullYear(),type:h},{preserveScroll:!0,preserveState:!0,onSuccess:()=>{f(!1)},onError:()=>{f(!1),u("Erreur lors du chargement des données.","error")}})},P=()=>{const t=he(D);return Object.entries(t).map(([r,a])=>({date:r,total:a.total.toFixed(2)})).sort((r,a)=>r.date.localeCompare(a.date))},Z=t=>{if(t.preventDefault(),D.length===0||D.every(s=>!s.designation)){u("Aucune donnée à enregistrer.","warning");return}const r=D.filter(s=>s.designation||s.quantity||s.price);if(r.some(s=>!s.date||!s.fournisseur||!s.designation||!s.quantity||!s.price||!s.unite)){u("Veuillez remplir tous les champs obligatoires.","error");return}const c=r.filter(s=>{const d=new Date(s.date);return d.getMonth()+1!==m.getMonth()+1||d.getFullYear()!==m.getFullYear()});if(c.length>0){const s=c.map(d=>{const w=new Date(d.date);return`${d.designation}: ${w.toLocaleDateString("fr-FR")}`}).join(", ");if(!confirm(`Attention: Certaines dates sont en dehors du mois sélectionné (${s}). Ces entrées seront automatiquement placées dans le mois correspondant à leur date. Voulez-vous continuer?`))return}f(!0);const p=r.filter(s=>s.date&&s.fournisseur&&s.designation&&s.quantity&&s.price&&s.unite),v={};p.forEach(s=>{const d=new Date(s.date),w=d.getMonth()+1,T=`${d.getFullYear()}-${w}`;v[T]||(v[T]=[]);const E={...s,date:O(d),type:h||s.type||"gastro",total_ttc:I(s.quantity,s.price)};v[T].push(E)});const M=Object.entries(v).map(([s,d])=>{const[w,U]=s.split("-").map(Number);return{restaurant_id:i.id,rows:d,month:U,year:w,type:h||"gastro",day_total:d.reduce((T,E)=>T+parseFloat(E.total_ttc),0).toFixed(2)}});let Y=0,_=0;const G=()=>{if(Y++,Y===M.length){f(!1),_===M.length?u("Toutes les données ont été enregistrées avec succès.","success"):u(`${_} sur ${M.length} mois ont été enregistrés avec succès.`,"warning");const s=h===""?null:h;R.get(route("bml.show",[i.slug]),{month:m.getMonth()+1,year:m.getFullYear(),type:s},{preserveScroll:!0,preserveState:!0})}};M.length>0?M.forEach(s=>{const d=new Date(s.year,s.month-1).toLocaleDateString("fr-FR",{month:"long",year:"numeric"});R.post(route("bml.update-value"),s,{onSuccess:()=>{_++,(s.month!==m.getMonth()+1||s.year!==m.getFullYear())&&u(`Données pour ${d} enregistrées avec succès.`,"info"),G()},onError:w=>{u(`Erreur lors de l'enregistrement pour ${d}.`,"error"),console.error("Submission errors:",w),G()}})}):(f(!1),u("Aucune donnée valide à enregistrer.","warning"))};return o("div",{className:"p-4 sm:p-6",children:[e("div",{className:"bg-white rounded-lg shadow p-4 mb-6",children:o("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[o("div",{className:"flex-1 flex items-center gap-4",children:[o("div",{children:[e("h2",{className:"text-lg font-semibold text-gray-900",children:"BML"}),o("p",{className:"mt-1 text-sm text-gray-600",children:[i.name," -"," ",m.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})]})]}),e("div",{className:"relative",children:o("select",{value:h,onChange:Q,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 py-2 pl-3 pr-10 text-base",disabled:g,children:[e("option",{value:"",children:"Tous les types"}),Object.entries(x).map(([t,r])=>e("option",{value:r,children:t},r))]})})]}),e("div",{className:"flex-shrink-0",children:e("input",{type:"month",value:`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}`,onChange:W,className:"block w-full sm:w-auto border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500",disabled:g})})]})}),e("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:o("form",{onSubmit:Z,children:[g&&o("div",{className:"p-4 text-center",children:[e("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),e("p",{className:"mt-2 text-gray-600",children:"Chargement en cours..."})]}),e("div",{className:"overflow-x-auto",children:o("table",{className:"min-w-full divide-y divide-gray-200",children:[e("thead",{className:"bg-gray-50",children:o("tr",{children:[e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Date"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Fournisseur"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Designation"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Quantité"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Unité"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Prix"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Total TTC"}),e("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Action"})]})}),o("tbody",{className:"bg-white divide-y divide-gray-200",children:[D.map(t=>{var r;return o("tr",{className:"hover:bg-gray-50 transition-colors duration-150",children:[o("td",{className:`px-4 py-2 ${F(t.date)?"bg-yellow-50":""}`,children:[o("div",{className:"relative",children:[e("input",{type:"date",value:t.date||"",onChange:a=>N(t.id,"date",a.target.value),className:`w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150 ${F(t.date)?"border-yellow-400 bg-yellow-50":""}`,required:!0,disabled:g,max:O(new Date)}),F(t.date)&&e("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e("svg",{className:"h-5 w-5 text-yellow-500",fill:"currentColor",viewBox:"0 0 20 20",children:e("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),F(t.date)&&e("div",{className:"text-xs text-yellow-600 mt-1",children:"Date hors du mois sélectionné"})]}),e("td",{className:"px-4 py-2",children:e("input",{type:"text",value:t.fournisseur,onChange:a=>N(t.id,"fournisseur",a.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",required:!0,disabled:!0})}),o("td",{className:"px-4 py-2 relative",children:[e("input",{id:`designation-${t.id}`,type:"text",value:t.designation,onChange:a=>N(t.id,"designation",a.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",required:!0,disabled:g,autoComplete:"off",onFocus:()=>B(t.id),onBlur:()=>{setTimeout(()=>B(null),200)}}),!g&&J===t.id&&o("div",{className:"absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-md shadow-md z-50 max-h-40 overflow-y-auto",children:[(r=$[h])==null?void 0:r.map((a,c)=>e("div",{className:"px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm",onMouseDown:p=>{p.preventDefault(),N(t.id,"designation",a)},children:a},c)),(!$[h]||$[h].length===0)&&e("div",{className:"px-3 py-2 text-sm text-gray-500",children:"Aucune suggestion"})]})]}),e("td",{className:"px-4 py-2",children:e("input",{type:"number",value:t.quantity,onChange:a=>N(t.id,"quantity",a.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",min:"0",step:"0.01",required:!0,disabled:g})}),e("td",{className:"px-4 py-2",children:o("div",{className:"relative",children:[e("input",{type:"text",list:"unite-options",value:t.unite,onChange:a=>N(t.id,"unite",a.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",required:!0,disabled:g}),e("datalist",{id:"unite-options",children:pe.map((a,c)=>e("option",{value:a},c))})]})}),e("td",{className:"px-4 py-2",children:e("input",{type:"number",value:t.price,onChange:a=>N(t.id,"price",a.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",min:"0",step:"0.01",required:!0,disabled:g})}),e("td",{className:"px-4 py-2",children:o("div",{className:"text-sm text-gray-900 font-medium",children:[parseFloat(t.total_ttc).toFixed(2)," ","MAD"]})}),e("td",{className:"px-4 py-2",children:e("button",{type:"button",onClick:()=>X(t.id),className:"text-red-600 hover:text-red-800 disabled:opacity-50",disabled:g||D.length<=1,children:e(le,{className:"h-5 w-5"})})})]},t.id)}),e("tr",{className:"bg-gray-50",children:o("td",{colSpan:"8",className:"px-4 py-3",children:[e("div",{className:"font-semibold text-gray-900 mb-2",children:"Totaux par jour"}),e("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:P().map(t=>o("div",{className:"flex justify-between items-center bg-white p-2 rounded-md shadow-sm",children:[e("span",{className:"text-sm text-gray-600",children:new Date(t.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}),o("span",{className:"font-medium text-gray-900",children:[parseFloat(t.total).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})," ","MAD"]})]},t.date))}),o("div",{className:"mt-3 flex justify-end items-center border-t pt-2",children:[e("span",{className:"text-sm font-medium text-gray-600 mr-2",children:"Total du mois:"}),o("span",{className:"text-lg font-bold text-gray-900",children:[P().reduce((t,r)=>t+parseFloat(r.total),0).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})," ","MAD"]})]})]})})]})]})}),o("div",{className:"p-4 flex justify-between items-center bg-gray-50",children:[o("button",{type:"button",onClick:K,className:"inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50",disabled:g,children:[e(oe,{className:"h-4 w-4 mr-2"}),"Ajouter une ligne"]}),e("button",{type:"submit",className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",disabled:g,children:g?"Enregistrement...":"Enregistrer"})]})]})}),e(me,{toasts:k,removeToast:A})]})}export{xe as default};
