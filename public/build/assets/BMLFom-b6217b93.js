import{j as t,R as Z,r as v,a as o,f as O}from"./app-8d369fe0.js";import{c as F}from"./createLucideIcon-1db08a77.js";/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],te=F("CircleAlert",ee);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],se=F("CircleCheckBig",re);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],ne=F("CirclePlus",ae);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]],ie=F("Trash2",oe);/**
 * @license lucide-react v0.473.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],ce=F("X",le),de=({message:i,type:c="success",onClose:n})=>(v.useEffect(()=>{const N=setTimeout(()=>{n()},3e3);return()=>clearTimeout(N)},[n]),o("div",{className:`fixed top-4 right-4 flex items-center p-4 mb-4 rounded-lg shadow-lg ${c==="success"?"bg-green-50 text-green-800":"bg-red-50 text-red-800"}`,children:[t("div",{className:"inline-flex items-center justify-center flex-shrink-0 w-8 h-8",children:c==="success"?t(se,{className:"w-5 h-5 text-green-600"}):t(te,{className:"w-5 h-5 text-red-600"})}),t("div",{className:"ml-3 text-sm font-normal",children:i}),t("button",{onClick:n,className:"ml-4 -mx-1.5 -my-1.5 bg-transparent text-gray-400 hover:text-gray-900 rounded-lg p-1.5 inline-flex h-8 w-8",children:t(ce,{className:"w-5 h-5"})})]})),ue=({toasts:i,removeToast:c})=>t("div",{className:"fixed top-0 right-0 z-50 p-4 space-y-4",children:i.map(n=>t(de,{message:n.message,type:n.type,onClose:()=>c(n.id)},n.id))}),me=()=>{const[i,c]=Z.useState([]);return{toasts:i,addToast:(f,T="success")=>{const m=Date.now();c(_=>[..._,{id:m,message:f,type:T}])},removeToast:f=>{c(T=>T.filter(m=>m.id!==f))}}},ge={gastro:["Mozzarella Milka","Creme Fraîche","PERLA CERISE","Mozzarella cerise"],giada:["Mozzarella","Stracciatella","Buratta","Ricotta"],legume:["Roquette","EPINARD","Tomate cerise","Poivron Rouge","Poivron vert","CHAMPIGNON","CITRON","ORANGUE","CONCOMBRE","AIL","Basilic","Courgette","OIGNON"],boisson:["Coca","Coca Zero","Hawaei","Sprite","POMS","Citron","Tonic"]},pe=["Kg","KG","250G","unite","L","Botte","BROT","paquet de 24 U","Pot de 1 kg"],q=i=>{if(!i)return"";try{const c=i instanceof Date?i:new Date(i),n=c.getTimezoneOffset()*6e4;return new Date(c.getTime()-n).toISOString().split("T")[0]}catch(c){return console.error("Error formatting date:",c),""}},he=i=>i.reduce((n,N)=>{const f=N.date;return f&&(n[f]||(n[f]={rows:[],total:0}),n[f].rows.push(N),n[f].total+=parseFloat(N.total_ttc)||0),n},{}),j=i=>{switch(i){case"gastro":return"GASTRO";case"giada":return"GIADA";case"legume":return"Legume";case"boisson":return"COCA COLA";default:return""}},A=i=>i.toLowerCase().trim();function xe({restaurant:i,currentMonth:c,existingEntries:n=[],types:N={},currentType:f=""}){const{toasts:T,addToast:m,removeToast:_}=me(),[g,V]=v.useState(new Date(c.year,c.month-1)),[p,W]=v.useState(f),[h,x]=v.useState(!1),B=v.useRef(!0),I=v.useRef(n),E=()=>({id:Date.now()+Math.floor(Math.random()*1e3),fournisseur:j(p),designation:"",quantity:"",price:"",unite:"",date:q(new Date),type:p,total_ttc:0}),[D,M]=v.useState([E()]);v.useEffect(()=>{if(B.current){B.current=!1;return}const r=JSON.stringify(I.current)!==JSON.stringify(n);if(I.current=n,!!r)if(n&&n.length>0){const e=n.map((a,l)=>({id:Date.now()+l,fournisseur:a.fournisseur||j(a.type),designation:a.designation||"",quantity:a.quantity||"",price:a.price||"",unite:a.unite||"",date:q(a.date),type:a.type||p,total_ttc:parseFloat(a.total_ttc)||0}));M(e)}else M([E()])},[n]);const P=(r,e)=>{const a=parseFloat(r)||0,l=parseFloat(e)||0;return(a*l).toFixed(2)},R=r=>{if(!r)return!1;const e=new Date(r);return e.getMonth()+1!==g.getMonth()+1||e.getFullYear()!==g.getFullYear()},H=()=>{M(r=>[...r,E()])},J=r=>{M(e=>e.length<=1?e:e.filter(a=>a.id!==r))},w=(r,e,a)=>{M(l=>l.map(d=>{if(d.id===r){const y={...d,[e]:a};return e==="type"&&(y.fournisseur=j(a)),(e==="quantity"||e==="price")&&(y.total_ttc=P(e==="quantity"?a:d.quantity,e==="price"?a:d.price)),y}return d}))},K=r=>{try{const e=r.target.value;console.log("Type changed to:",e),W(e),x(!0);const a=e===""?null:e,l=route("bml.show",[i.slug]);console.log("Navigating to:",l,"with type:",a),O.get(l,{month:g.getMonth()+1,year:g.getFullYear(),type:a},{preserveScroll:!0,preserveState:!0,onSuccess:d=>{console.log("Navigation successful",d),x(!1)},onError:d=>{console.error("Navigation error:",d),x(!1),m("Erreur lors du chargement des données.","error")}})}catch(e){console.error("Error in handleTypeChange:",e),x(!1),m("Une erreur est survenue lors du changement de type.","error")}},Q=r=>{const e=new Date(r.target.value);V(e),x(!0),O.get(route("bml.show",[i.slug]),{month:e.getMonth()+1,year:e.getFullYear(),type:p},{preserveScroll:!0,preserveState:!0,onSuccess:()=>{x(!1)},onError:()=>{x(!1),m("Erreur lors du chargement des données.","error")}})},Y=()=>{const r=he(D);return Object.entries(r).map(([e,a])=>({date:e,total:a.total.toFixed(2)})).sort((e,a)=>e.date.localeCompare(a.date))},X=r=>{if(r.preventDefault(),D.length===0||D.every(s=>!s.designation)){m("Aucune donnée à enregistrer.","warning");return}const e=D.filter(s=>s.designation||s.quantity||s.price);if(e.some(s=>!s.date||!s.fournisseur||!s.designation||!s.quantity||!s.price||!s.unite)){m("Veuillez remplir tous les champs obligatoires.","error");return}const l=e.filter(s=>{const u=new Date(s.date);return u.getMonth()+1!==g.getMonth()+1||u.getFullYear()!==g.getFullYear()});if(l.length>0){const s=l.map(u=>{const C=new Date(u.date);return`${u.designation}: ${C.toLocaleDateString("fr-FR")}`}).join(", ");if(!confirm(`Attention: Certaines dates sont en dehors du mois sélectionné (${s}). Ces entrées seront automatiquement placées dans le mois correspondant à leur date. Voulez-vous continuer?`))return}x(!0);const d=e.filter(s=>s.date&&s.fournisseur&&s.designation&&s.quantity&&s.price&&s.unite),y={};d.forEach(s=>{const u=new Date(s.date),C=u.getMonth()+1,S=`${u.getFullYear()}-${C}`;y[S]||(y[S]=[]);const z={...s,date:q(u),type:p||s.type||"gastro",total_ttc:P(s.quantity,s.price)};y[S].push(z)});const b=Object.entries(y).map(([s,u])=>{const[C,U]=s.split("-").map(Number);return{restaurant_id:i.id,rows:u,month:U,year:C,type:p||"gastro",day_total:u.reduce((S,z)=>S+parseFloat(z.total_ttc),0).toFixed(2)}});let k=0,$=0;const G=()=>{if(k++,k===b.length){x(!1),$===b.length?m("Toutes les données ont été enregistrées avec succès.","success"):m(`${$} sur ${b.length} mois ont été enregistrés avec succès.`,"warning");const s=p===""?null:p;O.get(route("bml.show",[i.slug]),{month:g.getMonth()+1,year:g.getFullYear(),type:s},{preserveScroll:!0,preserveState:!0})}};b.length>0?b.forEach(s=>{const u=new Date(s.year,s.month-1).toLocaleDateString("fr-FR",{month:"long",year:"numeric"});O.post(route("bml.update-value"),s,{onSuccess:()=>{$++,(s.month!==g.getMonth()+1||s.year!==g.getFullYear())&&m(`Données pour ${u} enregistrées avec succès.`,"info"),G()},onError:C=>{m(`Erreur lors de l'enregistrement pour ${u}.`,"error"),console.error("Submission errors:",C),G()}})}):(x(!1),m("Aucune donnée valide à enregistrer.","warning"))},L=(r,e)=>{if(!e)return[];const a=ge[e]||[];if(!r)return a;const l=A(r);return a.filter(d=>A(d).includes(l)).sort((d,y)=>{const b=A(d),k=A(y);return b===l&&k!==l?-1:k===l&&b!==l?1:b.startsWith(l)&&!k.startsWith(l)?-1:k.startsWith(l)&&!b.startsWith(l)?1:d.localeCompare(y)})};return o("div",{className:"p-4 sm:p-6",children:[t("div",{className:"bg-white rounded-lg shadow p-4 mb-6",children:o("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[o("div",{className:"flex-1 flex items-center gap-4",children:[o("div",{children:[t("h2",{className:"text-lg font-semibold text-gray-900",children:"BML"}),o("p",{className:"mt-1 text-sm text-gray-600",children:[i.name," -"," ",g.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})]})]}),t("div",{className:"relative",children:o("select",{value:p,onChange:K,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 py-2 pl-3 pr-10 text-base",disabled:h,children:[t("option",{value:"",children:"Tous les types"}),Object.entries(N).map(([r,e])=>t("option",{value:e,children:r},e))]})})]}),t("div",{className:"flex-shrink-0",children:t("input",{type:"month",value:`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}`,onChange:Q,className:"block w-full sm:w-auto border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500",disabled:h})})]})}),t("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:o("form",{onSubmit:X,children:[h&&o("div",{className:"p-4 text-center",children:[t("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"}),t("p",{className:"mt-2 text-gray-600",children:"Chargement en cours..."})]}),t("div",{className:"overflow-x-auto",children:o("table",{className:"min-w-full divide-y divide-gray-200",children:[t("thead",{className:"bg-gray-50",children:o("tr",{children:[t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Date"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Fournisseur"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Designation"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Quantité"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Unité"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Prix"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Total TTC"}),t("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0",children:"Action"})]})}),o("tbody",{className:"bg-white divide-y divide-gray-200",children:[D.map(r=>o("tr",{className:"hover:bg-gray-50 transition-colors duration-150",children:[o("td",{className:`px-4 py-2 ${R(r.date)?"bg-yellow-50":""}`,children:[o("div",{className:"relative",children:[t("input",{type:"date",value:r.date||"",onChange:e=>w(r.id,"date",e.target.value),className:`w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150 ${R(r.date)?"border-yellow-400 bg-yellow-50":""}`,required:!0,disabled:h,max:q(new Date)}),R(r.date)&&t("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:t("svg",{className:"h-5 w-5 text-yellow-500",fill:"currentColor",viewBox:"0 0 20 20",children:t("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),R(r.date)&&t("div",{className:"text-xs text-yellow-600 mt-1",children:"Date hors du mois sélectionné"})]}),t("td",{className:"px-4 py-2",children:t("input",{type:"text",value:r.fournisseur,onChange:e=>w(r.id,"fournisseur",e.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",required:!0,disabled:!0})}),t("td",{className:"px-4 py-2",children:o("div",{className:"relative",children:[t("input",{type:"text",list:`designations-${r.id}`,value:r.designation,onChange:e=>w(r.id,"designation",e.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",required:!0,disabled:h,autoComplete:"off"}),t("datalist",{id:`designations-${r.id}`,children:L(r.designation,p).map((e,a)=>t("option",{value:e},a))}),r.designation&&p&&L("",p).length>0&&t("div",{className:"absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-sm mt-1 z-10 max-h-40 overflow-y-auto",children:L(r.designation,p).slice(0,5).map((e,a)=>t("div",{className:"px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm",onClick:()=>w(r.id,"designation",e),children:e},a))})]})}),t("td",{className:"px-4 py-2",children:t("input",{type:"number",value:r.quantity,onChange:e=>w(r.id,"quantity",e.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",min:"0",step:"0.01",required:!0,disabled:h})}),t("td",{className:"px-4 py-2",children:o("div",{className:"relative",children:[t("input",{type:"text",list:"unite-options",value:r.unite,onChange:e=>w(r.id,"unite",e.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",required:!0,disabled:h}),t("datalist",{id:"unite-options",children:pe.map((e,a)=>t("option",{value:e},a))})]})}),t("td",{className:"px-4 py-2",children:t("input",{type:"number",value:r.price,onChange:e=>w(r.id,"price",e.target.value),className:"w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm transition-colors duration-150",min:"0",step:"0.01",required:!0,disabled:h})}),t("td",{className:"px-4 py-2",children:o("div",{className:"text-sm text-gray-900 font-medium",children:[parseFloat(r.total_ttc).toFixed(2)," ","MAD"]})}),t("td",{className:"px-4 py-2",children:t("button",{type:"button",onClick:()=>J(r.id),className:"text-red-600 hover:text-red-800 disabled:opacity-50",disabled:h||D.length<=1,children:t(ie,{className:"h-5 w-5"})})})]},r.id)),t("tr",{className:"bg-gray-50",children:o("td",{colSpan:"8",className:"px-4 py-3",children:[t("div",{className:"font-semibold text-gray-900 mb-2",children:"Totaux par jour"}),t("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:Y().map(r=>o("div",{className:"flex justify-between items-center bg-white p-2 rounded-md shadow-sm",children:[t("span",{className:"text-sm text-gray-600",children:new Date(r.date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}),o("span",{className:"font-medium text-gray-900",children:[parseFloat(r.total).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})," ","MAD"]})]},r.date))}),o("div",{className:"mt-3 flex justify-end items-center border-t pt-2",children:[t("span",{className:"text-sm font-medium text-gray-600 mr-2",children:"Total du mois:"}),o("span",{className:"text-lg font-bold text-gray-900",children:[Y().reduce((r,e)=>r+parseFloat(e.total),0).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2})," ","MAD"]})]})]})})]})]})}),o("div",{className:"p-4 flex justify-between items-center bg-gray-50",children:[o("button",{type:"button",onClick:H,className:"inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50",disabled:h,children:[t(ne,{className:"h-4 w-4 mr-2"}),"Ajouter une ligne"]}),t("button",{type:"submit",className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",disabled:h,children:h?"Enregistrement...":"Enregistrer"})]})]})}),t(ue,{toasts:T,removeToast:_})]})}export{xe as default};
