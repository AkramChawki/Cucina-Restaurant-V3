import{r as c,f as A,j as e,a}from"./app-6e375d07.js";import{E as j}from"./EnhancedThermalReceipt-5678cbbc.js";function T({restaurant:p}){const[i,y]=c.useState(null),[S,g]=c.useState(!0),[h,f]=c.useState(!1),[b,o]=c.useState("");c.useEffect(()=>{A.visit(`/thermal-receipts/restaurant/${p}`,{method:"get",onSuccess:n=>{n.props.receipt?(y(n.props.receipt),o("")):o("Aucun ticket trouvé pour ce restaurant"),g(!1)},onError:()=>{o("Erreur lors du chargement du ticket"),g(!1)},preserveState:!0})},[p]);const U=async()=>{var n,d,s,m,x,N,v,k;if(i)try{f(!0),console.log("Starting print process...");const u=j({receipt:i.data}),w=await navigator.serial.requestPort();await w.open({baudRate:9600});const r=w.writable.getWriter();try{await r.write(new Uint8Array([27,64]));for(const t of u){let l;switch(t.type){case"text":if((n=t.style)!=null&&n.bold&&await r.write(new Uint8Array([27,69,1])),(d=t.style)!=null&&d.underline&&await r.write(new Uint8Array([27,45,1])),(s=t.style)!=null&&s.align){const R=t.style.align==="center"?1:t.style.align==="right"?2:0;await r.write(new Uint8Array([27,97,R]))}((m=t.style)==null?void 0:m.size)==="L"&&await r.write(new Uint8Array([29,33,17])),l=new TextEncoder().encode(t.value+`
`),await r.write(l),(x=t.style)!=null&&x.bold&&await r.write(new Uint8Array([27,69,0])),(N=t.style)!=null&&N.underline&&await r.write(new Uint8Array([27,45,0])),(v=t.style)!=null&&v.align&&await r.write(new Uint8Array([27,97,0])),(k=t.style)!=null&&k.size&&await r.write(new Uint8Array([29,33,0]));break;case"line":const E=t.character||"-",D=42,L=E.repeat(D)+`
`;l=new TextEncoder().encode(L),await r.write(l);break;case"cut":l=new Uint8Array([29,86,65,0]),await r.write(l);break;default:console.log("Unknown command:",t);continue}}console.log("Print job completed successfully"),A.post(`/thermal-receipts/${i.id}/printed`,{},{preserveState:!0,onSuccess:()=>{y({...i,printed:!0})}})}finally{r.releaseLock(),await w.close()}}catch(u){console.error("Detailed error:",u),o(`Échec de l'impression. Erreur: ${u.message}`)}finally{f(!1)}};return S?e("div",{className:"flex justify-center items-center h-48",children:e("div",{className:"spinner border-4 border-blue-500 border-t-transparent rounded-full w-12 h-12 animate-spin"})}):b?e("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded",children:e("p",{children:b})}):i?a("div",{className:"bg-white shadow-md rounded-lg p-6",children:[a("h2",{className:"text-xl font-bold mb-4",children:["Dernier ticket pour ",p]}),e("div",{className:"mb-4",children:a("div",{className:"grid grid-cols-2 gap-4",children:[a("div",{children:[e("span",{className:"text-gray-600 font-medium",children:"ID:"}),a("span",{className:"ml-2",children:[i.receipt_id.substring(0,8),"..."]})]}),a("div",{children:[e("span",{className:"text-gray-600 font-medium",children:"Date:"}),e("span",{className:"ml-2",children:new Date(i.created_at).toLocaleDateString("fr-FR")})]}),a("div",{children:[e("span",{className:"text-gray-600 font-medium",children:"Heure:"}),e("span",{className:"ml-2",children:new Date(i.created_at).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})})]}),a("div",{children:[e("span",{className:"text-gray-600 font-medium",children:"Statut:"}),e("span",{className:`ml-2 px-2 py-1 text-xs font-semibold rounded-full ${i.printed?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:i.printed?"Imprimé":"Non imprimé"})]})]})}),a("div",{className:"border-t border-gray-200 py-4",children:[e("h3",{className:"font-semibold mb-2",children:"Contenu du ticket:"}),e("div",{className:"bg-gray-50 p-3 rounded border border-gray-200",children:i.data.thermal_blocks.map((n,d)=>a("div",{className:"mb-3",children:[e("h4",{className:"font-bold",children:n.type}),e("ul",{children:n.products.map((s,m)=>a("li",{children:[s.designation,": ",s.qty," ",s.unite]},m))})]},d))})]}),e("div",{className:"mt-4",children:e("button",{onClick:U,disabled:h,className:`text-white bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded ${h?"opacity-50 cursor-not-allowed":""}`,children:h?"Impression...":"Imprimer Ticket"})})]}):e("div",{className:"bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded",children:e("p",{children:"Aucun ticket disponible pour ce restaurant"})})}export{T as default};
